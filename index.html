<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alliance Tracker</title>
  <style>
    :root
    {
      --bg-deep:#071427;      /* dark polar night */
      --bg-mid:#0d1f3a;
      --ice:#4fd1ff;
      --ice-soft:#b9ecff;
      --glow:#4fd1ff44;
      --frost: rgba(0,0,0,.45);
      --border:rgba(255,255,255,.14);
      --text:#eaf6ff;
      --muted:#9fb6d4;
      --danger:#ff5c5c;
    }
    body
   {
      font-family: Arial, sans-serif;
      margin: 20px;
      color: var(--text);

      background:
        radial-gradient(1000px 600px at 15% 0%, var(--glow), transparent 60%),
        radial-gradient(800px 500px at 85% 10%, #4fd1ff22, transparent 55%),
        linear-gradient(var(--bg-mid), var(--bg-deep));
    }

    .row { display:flex; gap:10px; flex-wrap:wrap; margin: 8px 0; align-items: center; }
    input, select
    {
      padding:8px;
      border-radius:12px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
    }

    button
    {
      padding: 8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      color:white;

      background: linear-gradient(
        180deg,
        rgba(79,209,255,.35),
        rgba(79,209,255,.12)
      );

      cursor:pointer;
    }

    button:hover
    {
      filter:brightness(1.15);
      box-shadow:0 0 10px var(--glow);
    }

    table
    {
      border-collapse: collapse;
      width: 100%;
      margin-top: 12px;
    }

    th, td
    {
      border: 1px solid rgba(255,255,255,.14);
      padding: 10px;
      color: #eaf6ff;
      text-align: center;   /* center everything by default */
    }

    td:first-child,
    th:first-child
    {
      text-align: left;     /* Name column left aligned */
    }
    
    th
    {
      background: rgba(255,255,255,.08);
      color: #b9ecff;
      font-weight: 800;
    }

    tbody tr:hover
    {
      background: rgba(79,209,255,.08);
    }

    .card
    {
      background: var(--frost);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
      backdrop-filter: blur(8px);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .danger
    {
      background: linear-gradient(
        180deg,
        rgba(255,92,92,.45),
        rgba(255,92,92,.15)
      );
    }

    .small
    {
      font-size:12px;
      color:#9fb6d4;
    }

    .banner
    {
      height:200px;
      display:flex;
      border-radius:18px;
      overflow:hidden;
      margin-bottom:16px;
      border:1px solid rgba(255,255,255,.15);
      box-shadow:0 12px 35px rgba(0,0,0,.35);
      background:#071427;
    }

    .banner > div
    {
      flex:1;                 /* ðŸ‘ˆ equal 3 columns */
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .banner-center
    {
      background-image:url("images/wos-banner.jpg?v=1");
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
    }

    .banner-side
    {
      font-weight:900;
      font-size:88px;
      letter-spacing:6px;
      color:#4fd1ff;
      text-shadow:0 0 20px rgba(79,209,255,.6);
      user-select:none;
    }
  </style>
</head>
<body>

<div class="banner">
  <div class="banner-side left">TBD</div>
  <div class="banner-center"></div>
  <div class="banner-side right">657</div>
</div>

<h2>Alliance Player Tracker (v1)</h2>
<div class="small">Search by PID, click row to load, add/update/delete. Data saves to Google Sheets.</div>

<div class="card">
  <div class="row">
    <label>API URL:
      <input id="apiUrl" style="min-width:420px" placeholder="Paste Web App URL" />
    </label>
    <label>API Key:
      <input id="apiKey" placeholder="Your secret key" />
    </label>
    <button onclick="saveConfig()">Save</button>
    <button onclick="loadAll()">Load Players</button>
    <span id="msg" class="small"></span>
    <pre id="debug" class="small" style="white-space:pre-wrap; background:#111; color:#0f0; padding:10px; border-radius:8px; max-height:220px; overflow:auto; margin-top:10px;"></pre>
  </div>
</div>

<div class="card">
  <h3>Search / Edit</h3>
  <div class="row">
    <input id="searchPid" placeholder="Search PID" />
    <button onclick="searchByPID()">Search</button>
    <button onclick="clearForm()">Clear</button>
    <button class="danger" onclick="deletePID()">Delete PID</button>
  </div>

  <div class="row">
    <input id="PID" placeholder="PID (required)" />
    <input id="Name" placeholder="Name" />
    <input id="City_FC_Level" placeholder="City_FC_Level" />
    <input id="Game_Power" placeholder="Game_Power" />
    <input id="Foundry_Power" placeholder="Foundry_Power" />
  </div>

  <div class="row">
    <label>Helios_Infantry
      <select id="Helios_Infantry">
        <option value=""></option><option>Yes</option><option>No</option>
      </select>
    </label>
    <input id="Infantry_FC_Level" placeholder="Infantry_FC_Level" />

    <label>Helios_Marksmen
      <select id="Helios_Marksmen">
        <option value=""></option><option>Yes</option><option>No</option>
      </select>
    </label>
    <input id="Marksmen_FC_Level" placeholder="Marksmen_FC_Level" />

    <label>Helios_Lancer
      <select id="Helios_Lancer">
        <option value=""></option><option>Yes</option><option>No</option>
      </select>
    </label>
    <input id="Lancer_FC_Level" placeholder="Lancer_FC_Level" />
  </div>

  <div class="row">
    <button onclick="upsert()">Add / Update</button>
  </div>
</div>

<div class="card">
  <h3>All Players</h3>
  <div class="row">
    <button onclick="resetToSheetOrder()">Reset to Sheet Order</button>
  </div>
  <table>
    <thead>
      <tr>
        <th data-sort="Name">Name</th>
        <th data-sort="PID">PID</th>
        <th data-sort="Game_Power">Game Power</th>
        <th data-sort="City_FC_Level">City FC</th>
        <th data-sort="Foundry_Power">Foundry</th>
        <th data-sort="Helios_Infantry">Inf</th>
        <th data-sort="Infantry_FC_Level">Inf FC</th>
        <th data-sort="Helios_Marksmen">Mark</th>
        <th data-sort="Marksmen_FC_Level">Mark FC</th>
        <th data-sort="Helios_Lancer">Lan</th>
        <th data-sort="Lancer_FC_Level">Lan FC</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
  // These MUST match your sheet headers exactly:
  const FIELDS = [
    "Name","PID","City_FC_Level","Game_Power","Foundry_Power",
    "Helios_Infantry","Infantry_FC_Level",
    "Helios_Marksmen","Marksmen_FC_Level",
    "Helios_Lancer","Lancer_FC_Level"
  ];

  function setMsg(t){ document.getElementById("msg").textContent = t; }

  function setDebug(obj)
  {
    document.getElementById("debug").textContent =
      typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
  }

  let currentList = [];
  let sheetDefaultOrder = [];

  let sortState = { key: null, dir: 1 };

  function parseNumberLike(v)
  {
    if (v === null || v === undefined) return NaN;
    const s = String(v).replace(/,/g, "").trim();
    const n = Number(s);
    return Number.isFinite(n) ? n : NaN;
  }

  function normPid(v)
  {
    return String(v ?? "").replace(/[\s,]/g, "").trim();
  }

  function compareValues(a, b, key)
  {
    const numericKeys = new Set([
      "Game_Power","Foundry_Power",
      "City_FC_Level","Infantry_FC_Level",
      "Marksmen_FC_Level","Lancer_FC_Level"
    ]);

    if (numericKeys.has(key))
    {
      const an = parseNumberLike(a[key]);
      const bn = parseNumberLike(b[key]);

      const aBad = !Number.isFinite(an);
      const bBad = !Number.isFinite(bn);

      if (aBad && bBad) return 0;
      if (aBad) return 1;   // blanks go to bottom
      if (bBad) return -1;

      return an - bn;
    }

    const as = (a[key] ?? "").toString().toLowerCase();
    const bs = (b[key] ?? "").toString().toLowerCase();
    return as.localeCompare(bs);
}


  function sortBy(key) 
  {
    if (sortState.key === key) sortState.dir *= -1;
    else { sortState.key = key; sortState.dir = 1; }

    currentList = [...currentList].sort((a,b) =>
      sortState.dir * compareValues(a,b,key)
    );

    renderTable(currentList);
    updateHeaderArrows();
  }

  function updateHeaderArrows()
  {
    document.querySelectorAll("th[data-sort]").forEach(th => {
      const k = th.dataset.sort;
      const base = th.dataset.base || th.textContent.replace(/[â–²â–¼]/g,"").trim();
      th.dataset.base = base;
      th.textContent = k === sortState.key
        ? base + (sortState.dir === 1 ? " â–²" : " â–¼")
        : base;
    });
  }

  function initSorting()
  {
    document.querySelectorAll("th[data-sort]").forEach(th => {
      th.style.cursor = "pointer";
      th.addEventListener("click", () => sortBy(th.dataset.sort));
    });
  }

  function saveConfig(){
    localStorage.setItem("apiUrl", document.getElementById("apiUrl").value.trim());
    localStorage.setItem("apiKey", document.getElementById("apiKey").value.trim());
    setMsg("Saved config.");
  }

  function loadConfig()
  {
    document.getElementById("apiUrl").value = localStorage.getItem("apiUrl") || "";
    document.getElementById("apiKey").value = localStorage.getItem("apiKey") || "";
  }

  function cfg(){
    return {
      url: document.getElementById("apiUrl").value.trim(),
      key: document.getElementById("apiKey").value.trim(),
    };
  }

   async function apiGet(params = {}) 
   {
      try 
      {
        const { url, key } = cfg();
        if (!url) return { ok: false, error: "Missing API URL" };
  
        const u = new URL(url);
        u.searchParams.set("key", key);
        Object.entries(params).forEach(([k, v]) => u.searchParams.set(k, v));
  
        const r = await fetch(u.toString());
        return await r.json();
      } 
      catch (e) 
      {
        return { ok: false, error: e.message };
      }
  }

  async function apiPost(action, payload) 
  {
    try {
      const { url, key } = cfg();
      if (!url) return { ok: false, error: "Missing API URL" };
  
      const u = new URL(url);
      u.searchParams.set("key", key);
      u.searchParams.set("action", action);
      u.searchParams.set("payload", JSON.stringify(payload));
  
      const r = await fetch(u.toString());
      return await r.json();
    } catch (e) {
      return { ok: false, error: e.message };
    }
  }


  function clearForm(){
    FIELDS.forEach(f => {
      const el = document.getElementById(f);
      if (el) el.value = "";
    });
    setMsg("");
  }

  function fillForm(m){
    FIELDS.forEach(f => {
      const el = document.getElementById(f);
      if (el) el.value = (m[f] ?? "");
    });
  }

  function readForm(){
    const obj = {};
    FIELDS.forEach(f => obj[f] = document.getElementById(f).value);
    // force PID trim
    obj["PID"] = (obj["PID"] || "").toString().trim();
    return obj;
  }

  function renderTable(list){
    const tb = document.getElementById("tbody");
    tb.innerHTML = "";
    list.forEach(m => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${m.Name ?? ""}</td>
        <td>${m.PID ?? ""}</td>
        <td>${m.Game_Power ?? ""}</td>
        <td>${m.City_FC_Level ?? ""}</td>
        <td>${m.Foundry_Power ?? ""}</td>
        <td>${m.Helios_Infantry ?? ""}</td>
        <td>${m.Infantry_FC_Level ?? ""}</td>
        <td>${m.Helios_Marksmen ?? ""}</td>
        <td>${m.Marksmen_FC_Level ?? ""}</td>
        <td>${m.Helios_Lancer ?? ""}</td>
        <td>${m.Lancer_FC_Level ?? ""}</td>
      `;
      tr.style.cursor = "pointer";
      tr.onclick = () => fillForm(m);
      tb.appendChild(tr);
    });
  }

 async function loadAll() 
 {
  setMsg("Loading...");
  const res = await apiGet();
  if (!res.ok) return setMsg(res.error || "Error loading");

  // Always treat the sheet response as source of truth
  sheetDefaultOrder = res.members || [];
  currentList = [...sheetDefaultOrder];

  // Render exactly in sheet order on load
  renderTable(currentList);

  // Clear any previous column sort UI
  sortState.key = null;
  sortState.dir = 1;
  updateHeaderArrows();

  setMsg(`Loaded ${currentList.length} players.`);
}


  async function searchByPID(){
    const pid = document.getElementById("searchPid").value.trim();
    if (!pid) return setMsg("Enter a PID.");
    const res = await apiGet({ pid });
    if (!res.ok) return setMsg(res.error || "Not found");
    fillForm(res.member);
    setMsg("Loaded member.");
  }

 async function upsert(){
  const data = readForm();
  if (!data.PID) return setMsg("PID is required.");

  setMsg("Saving...");
  try{
    const res = await apiPost("upsert", data);

    if (!res.ok) {
      setMsg("Save failed: " + (res.error || "Unknown error"));
      return;
    }

    setMsg(`âœ… ${res.message || "Saved"} (PID ${data.PID})`);
    await loadAll();
  } catch (err){
    setMsg("Save failed (network): " + err.message);
    setDebug(String(err));
  }
}


  async function deletePID(){
  const pid = (document.getElementById("PID").value || document.getElementById("searchPid").value).trim();
  if (!pid) return setMsg("Enter/load a PID first.");
  if (!confirm(`Delete PID ${pid}?`)) return;

  setMsg("Deleting...");
  try{
    const res = await apiPost("delete", { PID: pid });

    if (!res.ok) {
      setMsg("Delete failed: " + (res.error || "Unknown error"));
      return;
    }

    clearForm();
    setMsg(`âœ… Deleted (PID ${pid})`);
    await loadAll();
  } catch (err){
    setMsg("Delete failed (network): " + err.message);
    setDebug(String(err));
  }
}


 function resetToSheetOrder() 
 {
    loadAll();
    setMsg("âœ… Reset to Google Sheet order.");
  }



  loadConfig();
  initSorting();
  loadAll();
</script>

</body>
</html>



